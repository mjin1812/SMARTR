---
title: "4. Example analysis notebook"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Example LH Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

# 1 Analysis Setup

In this analysis tutorial we will load the learned helplessness dataset as an experiment object and walk through the analysis and visualization functions in SMARTR with it. You can download the learneod helplessness dataset [here](https://osf.io/fhrxj)! Please see the accompanying paper for an in-depth explanation of the behavioral groups used in this experiment.

## 1.1 Load the libraries and data needed

```{r}
library(SMARTR)
library(tidyverse)
```


Load the experiment object

```{r}
# Load the experiment data 
load("V:\\Michelle_Jin\\Wholebrain pipeline\\LH_analysis\\learned_helplessness_experiment.RDATA")

# Change where the analysis folder is stored in the experiment object
attr(lh, "info")$output_path <- "V:\\Michelle_Jin\\Wholebrain pipeline\\LH_analysis" # edit this path to point your own folder location

# print the experiment object to see what attributes are available
print(lh)

```
Print the names of the current data stored within the experiment object
```{r}
print(names(lh))
```

## 1.2 Combine the processed cell counts across all the mice. 



This concatenates the normalized regional cell count table from each mouse into one long dataframe. The `by` parameter is a list of the mouse attributes types you want to use to make analysis subgroups. For example, you would include `by = c('sex','age')` if you wanted to perform an analysis where the data is grouped by both males and females and age of the subjects. 

In our dataset `Shock` and `Context` are stored in the flexible generic attribute `group`, so we use that for the `by` variable.
```{r}
lh <- combine_norm_cell_counts(lh, by = c('group'))

# print the name of stored data
print(names(lh))
```
There should now be a new list called `combined_normalized_counts`, where each element is a combined normalized cell count table per channel.


## 1.3 Normalize colabelled counts by a particular  channel.

This is an optional step, but is particularly pertinent to those doing engram research. Sometimes we want to normalize the number of colabelled cells per region over the number of eYFP cells or c-Fos cells.


This allows use to gauge the fraction of cells "reactivated" from an original ensemble population (colabel+/eYFP+) or the number of reactivated cells as a proportion of the ensembles involved in memory expression (colabel+/c-Fos+).  The necessi



```{r}

# Normalize the colabelled counts by a particular channel
lh <- normalize_colabel_counts(lh, denominator_channel = "eyfp")
lh <- normalize_colabel_counts(lh, denominator_channel = "cfos")

```

## 1.2 Quality checks



Quality checking the data 

```{r}
lh <- find_outlier_counts(lh, by = c("group"), n_sd = 2, remove = TRUE, log = TRUE)
```

```{r}
lh <- enough_mice_per_group(lh, by = c("group"), min_n = 4, remove = TRUE, log = TRUE)
```

## Plotting normalized long regional bar plot across all regions
```{r}

# User-chosen hexadecimal color codes per group
eyfp.colors <- c(Context = "#FFFFFF", Shock = "#028A0F")  
cfos.colors <- c(Context = "#FFFFFF", Shock = "#ff2a04")
colabel.colors <- c(Context = "#FFFFFF", Shock = "#ffc845")

plot_normalized_counts(e = lh,
                       channels = c("cfos"),
                       groups = c("Context", "Shock"),
                       regions_to_remove = c("CTX", "grey", "MB", "TH", "HY", "IPN"),
                       colors = cfos.colors,
                       title = NULL,
                       height = 11,
                       width = 7.5,
                       region_label_angle = 0,
                       label_text_size = 7,
                       print_plot = TRUE,
                       flip_axis = TRUE,
                       save_plot = TRUE,
                       facet_background_color = "#FFFFFF",
                       image_ext = ".pdf")

plot_normalized_counts(e = lh,
                       channels = c("eyfp"),
                       groups = c("Context", "Shock"),
                       regions_to_remove = c("CTX", "grey", "MB", "TH", "HY", "IPN"),
                       colors = eyfp.colors,
                       title = NULL,
                       height = 11,
                       width = 7.5,
                       region_label_angle = 0,
                       label_text_size = 7,
                       print_plot = TRUE,
                       flip_axis = TRUE,
                       save_plot = TRUE,
                       facet_background_color = "#FFFFFF",
                       image_ext = ".pdf")

plot_normalized_counts(e = lh,
                       channels = c("colabel"),
                       groups = c("Context", "Shock"),
                       regions_to_remove = c("CTX", "grey", "MB", "TH", "HY", "IPN"),
                       colors = colabel.colors,
                       title = NULL,
                       height = 11,
                       width = 7.5,
                       region_label_angle = 0,
                       label_text_size = 7,
                       print_plot = TRUE,
                       flip_axis = TRUE,
                       save_plot = TRUE,
                       facet_background_color = "#FFFFFF",
                       image_ext = ".pdf")

# Change the units because these counts are normalized by eYFP+ counts rather than by volume per mm^3
plot_normalized_counts(e = lh,
                       channels = c("colabel_over_eyfp"),
                       groups = c("Context", "Shock"),
                       regions_to_remove = c("CTX", "grey", "MB", "TH", "HY", "IPN"),
                       colors = colabel.colors,
                       title = NULL,
                       height = 11,
                       width = 7.5,
                       unit_label = "co-labelled/EYFP+",
                       region_label_angle = 0,
                       label_text_size = 7,
                       print_plot = TRUE,
                       flip_axis = TRUE,
                       save_plot = TRUE,
                       facet_background_color = "#e5f3e7",
                       image_ext = ".pdf")

# Change the units because these counts are normalized by c-Fos+ counts rather than by volume per mm^3
plot_normalized_counts(e = lh,
                       channels = c("colabel_over_cfos"),
                       groups = c("Context", "Shock"),
                       regions_to_remove = c("CTX", "grey", "MB", "TH", "HY", "IPN"),
                       colors = colabel.colors,
                       title = NULL,
                       height = 11,
                       width = 7.5,
                       unit_label = "co-labelled/c-Fos+",
                       region_label_angle = 0,
                       label_text_size = 7,
                       print_plot = TRUE,
                       flip_axis = TRUE,
                       save_plot = TRUE,
                       facet_background_color = "#ffe9e5",
                       image_ext = ".pdf")

```


## Correlation Heatmap Analysis


```{r}
lh <- get_correlations(lh,
                       by = c("group"),
                       values = c("Context"),
                       channels = c("eyfp"),
                       p_adjust_method = "none",
                       alpha = 0.005)

lh <- get_correlations(lh,
                       by = c("group"),
                       values = c("Shock"),
                       channels = c("eyfp"),
                       p_adjust_method = "none",
                       alpha = 0.005)

# lh <- get_correlations(lh,
#                        by = c("group"),
#                        values = c("Context"),
#                        channels = c("cfos"),
#                        p_adjust_method = "none",
#                        alpha = 0.002)
# 
# lh <- get_correlations(lh,
#                        by = c("group"),
#                        values = c("Shock"),
#                        channels = c("cfos"),
#                        p_adjust_method = "none",
#                        alpha = 0.002)
# 


# 
# 
# lh <- get_correlations(lh,
#                        by = c("group"),
#                        values = c("Context"),
#                        channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),
#                        p_adjust_method = "none",
#                        alpha = 0.01)
# # 
# lh <- get_correlations(lh,
#                        by = c("group"),
#                        values = c("Shock"),
#                        channels = c("colabel","colabel_over_eyfp", "colabel_over_cfos"),
#                        p_adjust_method = "none",
#                        alpha = 0.01)
```

```{r}
plot_correlation_heatmaps(lh, 
                          channels = c("cfos"),
                          correlation_list_name = "Context",
                          sig_color = "black",
                          sig_nudge_y = -0.8,
                          print_plot = FALSE,
                          colors = c("#be0000"),
                          save_plot = TRUE)

plot_correlation_heatmaps(lh, 
                          channels = c("cfos"),
                          correlation_list_name = "Shock",
                          sig_color = "black",
                          sig_nudge_y = -0.8,
                          print_plot = FALSE,
                          colors = c("#be0000"),
                          save_plot = TRUE)
```

# Plot with separate y_nudge factor

```{r}
plot_correlation_heatmaps(lh, 
                          channels = c("eyfp"),
                          correlation_list_name = "Context",
                          sig_color = "black",
                          sig_nudge_y = -0.7,
                          print_plot = FALSE,
                          colors = c( "#00782e"),
                          save_plot = TRUE)

plot_correlation_heatmaps(lh, 
                          channels = c("eyfp"),
                          correlation_list_name = "Shock",
                          sig_color = "black",
                          sig_nudge_y = -0.7,
                          print_plot = FALSE,
                          colors = c( "#00782e"),
                          save_plot = TRUE)
```


# Plot with a separate y_nudge factor for colabel channel
```{r}
plot_correlation_heatmaps(lh, 
                          channels = c("colabel"),
                          correlation_list_name = "Context",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)

plot_correlation_heatmaps(lh, 
                          channels = c("colabel"),
                          correlation_list_name = "Shock",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)
```

# Plot with a separate y_nudge factor for colabel channel normalized by eYFP
```{r}
plot_correlation_heatmaps(lh, 
                          channels = c("colabel_over_eyfp"),
                          correlation_list_name = "Context",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)

plot_correlation_heatmaps(lh, 
                          channels = c("colabel_over_eyfp"),
                          correlation_list_name = "Shock",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)
```

# Plot with a separate y_nudge factor for colabel channel normalized by cfos
```{r}
plot_correlation_heatmaps(lh, 
                          channels = c("colabel_over_cfos"),
                          correlation_list_name = "Context",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)

plot_correlation_heatmaps(lh, 
                          channels = c("colabel_over_cfos"),
                          correlation_list_name = "Shock",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)
     

```

                          
                          
                          
```{r}
# plot_correlation_heatmaps(lh, 
#                           # channels = c("eyfp"),
#                           channels = c("cfos", "eyfp", "colabel"),
#                           correlation_list_name = "Context",
#                           colors = c("#be0000"),
#                           # sig_color = "black",
#                           sig_nudge_y = -0.5,
#                           colors = c("#be0000", "#00782e", "#f09b08"),
#                           save_plot = TRUE)
# 
# plot_correlation_heatmaps(lh, 
#                           channels = c("cfos", "eyfp", "colabel"),
#                           # channels = c("eyfp"),
#                           correlation_list_name = "Shock",
#                           sig_color = "black",
#                           colors = c("#be0000", "#00782e", "#f09b08"),
#                           # colors = c("#be0000"),
#                           save_plot = TRUE)
```


## Correlation permutation analysis




```{r, echo = FALSE}
lh <- correlation_diff_permutation(lh,
                                   correlation_list_name_1 = "Context",
                                   correlation_list_name_2 = "Shock",
                                   channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),
                                   # channels = c("eyfp"),
                                   # channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),  
                                   p_adjust_method = "none",
                                   alpha = 0.01
                                   )
```

```{r}


plt_theme <- ggplot2::theme_classic() + 
  theme(text = element_text(size = 34),
        line = element_line(size = 1.0),
        axis.line = element_line(colour = 'black', size = 1.0),
        plot.title = element_text(hjust = 0.5, size = 36),
        axis.ticks.length = unit(5.5,"points"),
        axis.text.x = element_text(colour = "black", size =34),
        axis.text.y = element_text(colour = "black", size = 34)
  )


volcano_plot(lh,
             permutation_comparison = "Context_vs_Shock",
             # channels = c("cfos", "eyfp", "colabel", "colabel_over_eyfp", "colabel_over_cfos"), 
             # channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"), 
             channels = c("eyfp"), 
             # colors =  c("#be0000", "#00782e", "#f09b08", "#f09b08", "#f09b08"),
             colors =  c("#00782e"),
             # colors =  c("#f09b08", "#f09b08", "#f09b08"),
             height = 8,
             width = 10,
             title = "",
             print_plot = FALSE,
             ylim = c(0,4),
             point_size = 2,
             plt_theme = plt_theme)
```

```{r}

plt_theme <- ggplot2::theme_classic() + 
  theme(text = element_text(size = 34),
        line = element_line(size = 1.0),
        axis.line = element_line(colour = 'black', size = 1.0),
        plot.title = element_text(hjust = 0.5, size = 36),
        axis.ticks.length = unit(5.5,"points"),
        axis.text.x = element_text(colour = "black", size =34),
        axis.text.y = element_text(colour = "black", size = 34)
  )



parallel_coordinate_plot(lh,
                         permutation_comparison = "Context_vs_Shock",
                         # channels = c( "colabel", "colabel_over_eyfp", "colabel_over_cfos"),
                         # colors =  c( "#f09b08", "#f09b08", "#f09b08"),
                         channels = c("cfos", "eyfp"),
                         colors =  c("#be0000", "#00782e"),
                         x_label_group_1 = "CT",
                         x_label_group_2 = "IS",
                         height = 8,
                         width = 10,
                         print_plot = FALSE,
                         reverse_group_order = FALSE,
                         label_size = 6,
                         plt_theme= plt_theme
                         )
```

```{r}
parallel_coordinate_plot(lh,
                         permutation_comparison = "Context_vs_Shock",
                         channels = c("colabel_over_eyfp", "colabel_over_cfos"), 
                         colors =  c("#be0000", "#00782e", "#f09b08", "#f09b08", "#f09b08"),
                         x_label_group_1 = "Context",
                         x_label_group_2 = "Shock",
                         height = 8,
                         width = 10,
                         print_plot = FALSE,
                         reverse_group_order = FALSE,
                         label_size = 6,
                         plt_theme= plt_theme,
                         nudge_x = 2:3
                         )
```



## Create networks

```{r}
# lh <- create_networks(lh,
#                       correlation_list_name = "Context",
#                       channels = c("eyfp"),
#                       alpha = 0.005)
# lh <- create_networks(lh,
#                       correlation_list_name = "Shock",
#                       channels = c("eyfp"),
#                       alpha = 0.005)
# lh <- create_networks(lh,
#                       correlation_list_name = "Context",
#                       channels = c("cfos"),
#                       alpha = 0.002)
# lh <- create_networks(lh,
#                       correlation_list_name = "Shock",
#                       channels = c("cfos"),
#                       alpha = 0.002)


lh <- create_networks(lh,
                      correlation_list_name = "Context",
                      channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),
                      alpha = 0.01)
lh <- create_networks(lh,
                      correlation_list_name = "Shock",
                      channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),
                      alpha = 0.01)
```


## TODO Fix the network plots


```{r}

graph_theme <- ggraph::theme_graph() + theme(plot.title = element_text(hjust = 0.5, size = 36),
                                             legend.text = element_text(size = 18),
                                             legend.title = element_text(size = 18))

plot_networks(lh,
              network_name ="Context",
              channels = c("eyfp"),
              title = "Context",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#00782e",
              label_size = 6,
              label_offset = 0.15)

plot_networks(lh,
              network_name = "Shock",
              channels = c("eyfp"),
              title = "Shock",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#00782e",
              label_size = 6,
              label_offset = 0.15)
```


```{r}
plot_networks(lh,
              network_name ="Context",
              channels = c("cfos"),
              title = "Context",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#be0000",
              label_size = 6,
              label_offset = 0.15)

plot_networks(lh,
              network_name = "Shock",
              channels = c("cfos"),
              title = "Shock",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#be0000",
              label_size = 6,
              label_offset = 0.15)

```



```{r}


plot_networks(lh,
              network_name ="Context",
              channels = c("colabel"),
              title = "Context",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

plot_networks(lh,
              network_name = "Shock",
              channels = c("colabel"),
              title = "Shock",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

```


```{r}


plot_networks(lh,
              network_name ="Context",
              channels = c("colabel_over_eyfp"),
              title = "Context",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

plot_networks(lh,
              network_name = "Shock",
              channels = c("colabel_over_eyfp"),
              title = "Shock",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

```


```{r}


plot_networks(lh,
              network_name ="Context",
              channels = c("colabel_over_cfos"),
              title = "Context",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

plot_networks(lh,
              network_name = "Shock",
              channels = c("colabel_over_cfos"),
              title = "Shock",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

```


```{r}
lh <- summarise_networks(lh, 
                         channels = c("eyfp"),
                         network_names = c("Context", "Shock"),
                         save_stats = TRUE,
                         save_degree_distribution = TRUE,
                         save_betweenness_distribution = TRUE,
                         save_efficiency_distribution = TRUE)

lh <- summarise_networks(lh, 
                         channels = c("cfos"),
                         network_names = c("Context", "Shock"),
                         save_stats = TRUE,
                         save_degree_distribution = TRUE,
                         save_betweenness_distribution = TRUE,
                         save_efficiency_distribution = TRUE)

lh <- summarise_networks(lh, 
                         channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),
                         network_names = c("Context", "Shock"),
                         save_stats = TRUE,
                         save_degree_distribution = TRUE,
                         save_betweenness_distribution = TRUE,
                         save_efficiency_distribution = TRUE)
```



# Perform pairwise comparisons in expression across brain regions and add FDR correction for multiple comparisons

```{r}
library(rstatix)
stats.eyfp <- lh$combined_normalized_counts$eyfp %>% group_by(acronym, name) %>% 
  t_test(normalized.count.by.volume~group) %>% adjust_pvalue(method = "BH") %>%
    add_significance()
stats.cfos <- lh$combined_normalized_counts$cfos %>% group_by(acronym, name) %>% 
  t_test(normalized.count.by.volume~group) %>% adjust_pvalue(method = "BH") %>%
    add_significance()
stats.colabel_over_eyfp <- lh$combined_normalized_counts$colabel_over_eyfp %>% group_by(acronym, name) %>% 
  t_test(normalized.count.by.volume~group) %>% adjust_pvalue(method = "BH") %>%
    add_significance()
stats.colabel_over_cfos <- lh$combined_normalized_counts$colabel_over_cfos %>% group_by(acronym, name) %>% 
  t_test(normalized.count.by.volume~group) %>% adjust_pvalue(method = "BH") %>%
    add_significance()
stats.colabel <- lh$combined_normalized_counts$colabel %>% group_by(acronym, name) %>% 
  t_test(normalized.count.by.volume~group) %>% adjust_pvalue(method = "BH") %>%
    add_significance()
```


# Pivot the tables longer to combine with the raw normalized counts

```{r}
# stats.eyfp %>% pivot_longer(cols= starts_with("group"), names_to = NULL, values_to = "group")

 wide_eyfp_norm_counts <- lh$combined_normalized_counts$eyfp %>% group_by(group, acronym, name) %>% 
      summarise(mean.normalized.count.by.volume = mean(normalized.count.by.volume),
      sem.normalized.count.by.volume = SMARTR::sem(normalized.count.by.volume),
      n = n())


 wide_eyfp_norm_counts <-  wide_eyfp_norm_counts %>% pivot_wider(names_from =  group, names_sep = ".", values_from = c(group, acronym, name, mean.normalized.count.by.volume, sem.normalized.count.by.volume, n)) %>% unnest() %>% rename(acronym = acronym.Context,
                          name = name.Context)
 
 
 joined_eyfp_stats <- wide_eyfp_norm_counts %>% select(c(name, acronym, starts_with("mean"), starts_with("sem"))) %>% right_join(stats.eyfp, by = c("acronym", "name")) %>% 
   select(-.y., -group1, -group2) %>% rename(n.Context = n1,
                                             n.Shock = n2)
 
 
 file_name <- attr(lh, "info")$output_path %>% file.path("eyfp_regions_stats_table.csv")
 write.csv(joined_eyfp_stats, file_name)
```


```{r}
# stats.cfos %>% pivot_longer(cols= starts_with("group"), names_to = NULL, values_to = "group")

 wide_cfos_norm_counts <- lh$combined_normalized_counts$cfos %>% group_by(group, acronym, name) %>% 
      summarise(mean.normalized.count.by.volume = mean(normalized.count.by.volume),
      sem.normalized.count.by.volume = SMARTR::sem(normalized.count.by.volume),
      n = n())


 wide_cfos_norm_counts <-  wide_cfos_norm_counts %>% pivot_wider(names_from =  group, names_sep = ".", values_from = c(group, acronym, name, mean.normalized.count.by.volume, sem.normalized.count.by.volume, n)) %>%  
      unnest() %>% rename(acronym = acronym.Context,
                          name = name.Context)
 
 
 joined_cfos_stats <- wide_cfos_norm_counts %>% select(c(name, acronym, starts_with("mean"), starts_with("sem"))) %>% right_join(stats.cfos, by = c("acronym", "name")) %>% 
   select(-.y., -group1, -group2) %>% rename(n.Context = n1,
                                             n.Shock = n2)
 
 
 file_name <- attr(lh, "info")$output_path %>% file.path("cfos_regions_stats_table.csv")
 write.csv(joined_cfos_stats, file_name)
```

```{r}
# stats.colabel_over_eyfp %>% pivot_longer(cols= starts_with("group"), names_to = NULL, values_to = "group")

 wide_colabel_over_eyfp_norm_counts <- lh$combined_normalized_counts$colabel_over_eyfp %>% group_by(group, acronym, name) %>% 
      summarise(mean.normalized.count.by.volume = mean(normalized.count.by.volume),
      sem.normalized.count.by.volume = SMARTR::sem(normalized.count.by.volume),
      n = n())


 wide_colabel_over_eyfp_norm_counts <-  wide_colabel_over_eyfp_norm_counts %>% pivot_wider(names_from =  group, names_sep = ".", values_from = c(group, acronym, name, mean.normalized.count.by.volume, sem.normalized.count.by.volume, n)) %>%  
      unnest() %>% rename(acronym = acronym.Context,
                          name = name.Context)
 
 
 joined_colabel_over_eyfp_stats <- wide_colabel_over_eyfp_norm_counts %>% select(c(name, acronym, starts_with("mean"), starts_with("sem"))) %>% right_join(stats.colabel_over_eyfp, by = c("acronym", "name")) %>% 
   select(-.y., -group1, -group2) %>% rename(n.Context = n1,
                                             n.Shock = n2)
 
 
 file_name <- attr(lh, "info")$output_path %>% file.path("colabel_over_eyfp_regions_stats_table.csv")
 write.csv(joined_colabel_over_eyfp_stats, file_name)
```

```{r}

 wide_colabel_over_cfos_norm_counts <- lh$combined_normalized_counts$colabel_over_cfos %>% group_by(group, acronym, name) %>% 
      summarise(mean.normalized.count.by.volume = mean(normalized.count.by.volume),
      sem.normalized.count.by.volume = SMARTR::sem(normalized.count.by.volume),
      n = n())


 wide_colabel_over_cfos_norm_counts <-  wide_colabel_over_cfos_norm_counts %>% pivot_wider(names_from =  group, names_sep = ".", values_from = c(group, acronym, name, mean.normalized.count.by.volume, sem.normalized.count.by.volume, n)) %>%  
      unnest() %>% rename(acronym = acronym.Context,
                          name = name.Context)
 
 
 joined_colabel_over_cfos_stats <- wide_colabel_over_cfos_norm_counts %>% select(c(name, acronym, starts_with("mean"), starts_with("sem"))) %>% right_join(stats.colabel_over_cfos, by = c("acronym", "name")) %>% 
   select(-.y., -group1, -group2) %>% rename(n.Context = n1,
                                             n.Shock = n2)
 
 file_name <- attr(lh, "info")$output_path %>% file.path("colabel_over_cfos_regions_stats_table.csv")
 write.csv(joined_colabel_over_cfos_stats, file_name)
```

```{r}


wide_colabel_norm_counts <- lh$combined_normalized_counts$colabel %>% group_by(group, acronym, name) %>% 
      summarise(mean.normalized.count.by.volume = mean(normalized.count.by.volume),
      sem.normalized.count.by.volume = SMARTR::sem(normalized.count.by.volume),
      n = n())


 wide_colabel_norm_counts <-  wide_colabel_norm_counts %>% pivot_wider(names_from =  group, names_sep = ".", values_from = c(group, acronym, name, mean.normalized.count.by.volume, sem.normalized.count.by.volume, n)) %>%  
      unnest() %>% rename(acronym = acronym.Context,
                          name = name.Context)
 
 
 joined_colabel_stats <- wide_colabel_norm_counts %>% select(c(name, acronym, starts_with("mean"), starts_with("sem"))) %>% right_join(stats.colabel, by = c("acronym", "name")) %>% 
   select(-.y., -group1, -group2) %>% rename(n.Context = n1,
                                             n.Shock = n2)
 
 file_name <- attr(lh, "info")$output_path %>% file.path("colabel_regions_stats_table.csv")
 write.csv(joined_colabel_stats, file_name)
