---
title: "4. Example analysis notebook"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Example LH Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```


# Load the libraries 

```{r}
library(SMARTR)
library(tidyverse)
```


# Briefing

Attached 



# Start here if creating experiment from scratch



```{r, eval = FALSE}
lh <- experiment(experiment_name = "learned_helplessness",
                         experimenters = c("MJ", "SO", "ML", "SS", "AW", "SLS", "CA"),
                         output_path = "V:\\Simon_Ogundare\\Learned Helplessness\\experiment_analysis_output")
```


# Load all mouse objects you want included in your analysis into the experiment object
```{r, eval = FALSE}
lh <- add_mouse(lh, m = mouse_829)
lh <- add_mouse(lh, m = mouse_831)
lh <- add_mouse(lh, m = mouse_833)
```


Save the experiment object into your your designated output_path location
```{r, eval = FALSE}
# Check that you loaded all the mice you need
print(names(lh$mice))

# Save the experiment
save_experiment(lh, timestamp = TRUE)
```


## Quality checks

```{r}
 # load("V:/Simon_Ogundare/Learned Helplessness/DV_Experiment_2/learned_helplessness_experiment_2023-08-28.RDATA")
```

```{r}
# Normalize the cell counts by area and volume
lh <- combine_norm_cell_counts(lh, by = c('group'))

# Normalize the colabelled counts by a particular channel
lh <- normalize_colabel_counts(lh, denominator_channel = "eyfp")
lh <- normalize_colabel_counts(lh, denominator_channel = "cfos")

```


Quality checking

```{r}
lh <- find_outlier_counts(lh, by = c("group"), n_sd = 2, remove = TRUE, log = TRUE)
```

```{r}
lh <- enough_mice_per_group(lh, by = c("group"), min_n = 4, remove = TRUE, log = TRUE)
```

## Plotting normalized long regional bar plot across all regions


```{r}
# eyfp.colors <- c(Context = "#FFFFFF", Shock = "#03AC03") # shamrock green
# eyfp.colors <- c(Context = "#FFFFFF", Shock = "#3CB043") # regular green
eyfp.colors <- c(Context = "#FFFFFF", Shock = "#028A0F")  # emerald green
cfos.colors <- c(Context = "#FFFFFF", Shock = "#ff2a04")
colabel.colors <- c(Context = "#FFFFFF", Shock = "#ffc845")

plot_normalized_counts(e = lh,
                       channels = c("cfos"),
                       groups = c("Context", "Shock"),
                       regions_to_remove = c("CTX", "grey", "MB", "TH", "HY", "IPN"),
                       colors = cfos.colors,
                       title = NULL,
                       height = 11,
                       width = 7.5,
                       region_label_angle = 0,
                       label_text_size = 7,
                       print_plot = TRUE,
                       flip_axis = TRUE,
                       save_plot = TRUE,
                       facet_background_color = "#FFFFFF",
                       image_ext = ".pdf")

plot_normalized_counts(e = lh,
                       channels = c("eyfp"),
                       groups = c("Context", "Shock"),
                       regions_to_remove = c("CTX", "grey", "MB", "TH", "HY", "IPN"),
                       colors = eyfp.colors,
                       title = NULL,
                       height = 11,
                       width = 7.5,
                       region_label_angle = 0,
                       label_text_size = 7,
                       print_plot = TRUE,
                       flip_axis = TRUE,
                       save_plot = TRUE,
                       facet_background_color = "#FFFFFF",
                       image_ext = ".pdf")

plot_normalized_counts(e = lh,
                       channels = c("colabel"),
                       groups = c("Context", "Shock"),
                       regions_to_remove = c("CTX", "grey", "MB", "TH", "HY", "IPN"),
                       colors = colabel.colors,
                       title = NULL,
                       height = 11,
                       width = 7.5,
                       region_label_angle = 0,
                       label_text_size = 7,
                       print_plot = TRUE,
                       flip_axis = TRUE,
                       save_plot = TRUE,
                       facet_background_color = "#FFFFFF",
                       image_ext = ".pdf")

# Change the units because these counts are normalized by eYFP+ counts rather than by volume per mm^3
plot_normalized_counts(e = lh,
                       channels = c("colabel_over_eyfp"),
                       groups = c("Context", "Shock"),
                       regions_to_remove = c("CTX", "grey", "MB", "TH", "HY", "IPN"),
                       colors = colabel.colors,
                       title = NULL,
                       height = 11,
                       width = 7.5,
                       unit_label = "co-labelled/EYFP+",
                       region_label_angle = 0,
                       label_text_size = 7,
                       print_plot = TRUE,
                       flip_axis = TRUE,
                       save_plot = TRUE,
                       facet_background_color = "#e5f3e7",
                       image_ext = ".pdf")

# Change the units because these counts are normalized by c-Fos+ counts rather than by volume per mm^3
plot_normalized_counts(e = lh,
                       channels = c("colabel_over_cfos"),
                       groups = c("Context", "Shock"),
                       regions_to_remove = c("CTX", "grey", "MB", "TH", "HY", "IPN"),
                       colors = colabel.colors,
                       title = NULL,
                       height = 11,
                       width = 7.5,
                       unit_label = "co-labelled/c-Fos+",
                       region_label_angle = 0,
                       label_text_size = 7,
                       print_plot = TRUE,
                       flip_axis = TRUE,
                       save_plot = TRUE,
                       facet_background_color = "#ffe9e5",
                       image_ext = ".pdf")

```


## Correlation Heatmap Analysis


```{r}
lh <- get_correlations(lh,
                       by = c("group"),
                       values = c("Context"),
                       channels = c("eyfp"),
                       p_adjust_method = "none",
                       alpha = 0.005)

lh <- get_correlations(lh,
                       by = c("group"),
                       values = c("Shock"),
                       channels = c("eyfp"),
                       p_adjust_method = "none",
                       alpha = 0.005)

# lh <- get_correlations(lh,
#                        by = c("group"),
#                        values = c("Context"),
#                        channels = c("cfos"),
#                        p_adjust_method = "none",
#                        alpha = 0.002)
# 
# lh <- get_correlations(lh,
#                        by = c("group"),
#                        values = c("Shock"),
#                        channels = c("cfos"),
#                        p_adjust_method = "none",
#                        alpha = 0.002)
# 


# 
# 
# lh <- get_correlations(lh,
#                        by = c("group"),
#                        values = c("Context"),
#                        channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),
#                        p_adjust_method = "none",
#                        alpha = 0.01)
# # 
# lh <- get_correlations(lh,
#                        by = c("group"),
#                        values = c("Shock"),
#                        channels = c("colabel","colabel_over_eyfp", "colabel_over_cfos"),
#                        p_adjust_method = "none",
#                        alpha = 0.01)
```

```{r}
plot_correlation_heatmaps(lh, 
                          channels = c("cfos"),
                          correlation_list_name = "Context",
                          sig_color = "black",
                          sig_nudge_y = -0.8,
                          print_plot = FALSE,
                          colors = c("#be0000"),
                          save_plot = TRUE)

plot_correlation_heatmaps(lh, 
                          channels = c("cfos"),
                          correlation_list_name = "Shock",
                          sig_color = "black",
                          sig_nudge_y = -0.8,
                          print_plot = FALSE,
                          colors = c("#be0000"),
                          save_plot = TRUE)
```

# Plot with separate y_nudge factor

```{r}
plot_correlation_heatmaps(lh, 
                          channels = c("eyfp"),
                          correlation_list_name = "Context",
                          sig_color = "black",
                          sig_nudge_y = -0.7,
                          print_plot = FALSE,
                          colors = c( "#00782e"),
                          save_plot = TRUE)

plot_correlation_heatmaps(lh, 
                          channels = c("eyfp"),
                          correlation_list_name = "Shock",
                          sig_color = "black",
                          sig_nudge_y = -0.7,
                          print_plot = FALSE,
                          colors = c( "#00782e"),
                          save_plot = TRUE)
```


# Plot with a separate y_nudge factor for colabel channel
```{r}
plot_correlation_heatmaps(lh, 
                          channels = c("colabel"),
                          correlation_list_name = "Context",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)

plot_correlation_heatmaps(lh, 
                          channels = c("colabel"),
                          correlation_list_name = "Shock",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)
```

# Plot with a separate y_nudge factor for colabel channel normalized by eYFP
```{r}
plot_correlation_heatmaps(lh, 
                          channels = c("colabel_over_eyfp"),
                          correlation_list_name = "Context",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)

plot_correlation_heatmaps(lh, 
                          channels = c("colabel_over_eyfp"),
                          correlation_list_name = "Shock",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)
```

# Plot with a separate y_nudge factor for colabel channel normalized by cfos
```{r}
plot_correlation_heatmaps(lh, 
                          channels = c("colabel_over_cfos"),
                          correlation_list_name = "Context",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)

plot_correlation_heatmaps(lh, 
                          channels = c("colabel_over_cfos"),
                          correlation_list_name = "Shock",
                          sig_color = "black",
                          sig_nudge_y = -0.5,
                          print_plot = FALSE,
                          colors = c("#f09b08"),
                          save_plot = TRUE)
     

```

                          
                          
                          
```{r}
# plot_correlation_heatmaps(lh, 
#                           # channels = c("eyfp"),
#                           channels = c("cfos", "eyfp", "colabel"),
#                           correlation_list_name = "Context",
#                           colors = c("#be0000"),
#                           # sig_color = "black",
#                           sig_nudge_y = -0.5,
#                           colors = c("#be0000", "#00782e", "#f09b08"),
#                           save_plot = TRUE)
# 
# plot_correlation_heatmaps(lh, 
#                           channels = c("cfos", "eyfp", "colabel"),
#                           # channels = c("eyfp"),
#                           correlation_list_name = "Shock",
#                           sig_color = "black",
#                           colors = c("#be0000", "#00782e", "#f09b08"),
#                           # colors = c("#be0000"),
#                           save_plot = TRUE)
```


## Correlation permutation analysis




```{r, echo = FALSE}
lh <- correlation_diff_permutation(lh,
                                   correlation_list_name_1 = "Context",
                                   correlation_list_name_2 = "Shock",
                                   channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),
                                   # channels = c("eyfp"),
                                   # channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),  
                                   p_adjust_method = "none",
                                   alpha = 0.01
                                   )
```

```{r}


plt_theme <- ggplot2::theme_classic() + 
  theme(text = element_text(size = 34),
        line = element_line(size = 1.0),
        axis.line = element_line(colour = 'black', size = 1.0),
        plot.title = element_text(hjust = 0.5, size = 36),
        axis.ticks.length = unit(5.5,"points"),
        axis.text.x = element_text(colour = "black", size =34),
        axis.text.y = element_text(colour = "black", size = 34)
  )


volcano_plot(lh,
             permutation_comparison = "Context_vs_Shock",
             # channels = c("cfos", "eyfp", "colabel", "colabel_over_eyfp", "colabel_over_cfos"), 
             # channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"), 
             channels = c("eyfp"), 
             # colors =  c("#be0000", "#00782e", "#f09b08", "#f09b08", "#f09b08"),
             colors =  c("#00782e"),
             # colors =  c("#f09b08", "#f09b08", "#f09b08"),
             height = 8,
             width = 10,
             title = "",
             print_plot = FALSE,
             ylim = c(0,4),
             point_size = 2,
             plt_theme = plt_theme)
```

```{r}

plt_theme <- ggplot2::theme_classic() + 
  theme(text = element_text(size = 34),
        line = element_line(size = 1.0),
        axis.line = element_line(colour = 'black', size = 1.0),
        plot.title = element_text(hjust = 0.5, size = 36),
        axis.ticks.length = unit(5.5,"points"),
        axis.text.x = element_text(colour = "black", size =34),
        axis.text.y = element_text(colour = "black", size = 34)
  )



parallel_coordinate_plot(lh,
                         permutation_comparison = "Context_vs_Shock",
                         # channels = c( "colabel", "colabel_over_eyfp", "colabel_over_cfos"),
                         # colors =  c( "#f09b08", "#f09b08", "#f09b08"),
                         channels = c("cfos", "eyfp"),
                         colors =  c("#be0000", "#00782e"),
                         x_label_group_1 = "CT",
                         x_label_group_2 = "IS",
                         height = 8,
                         width = 10,
                         print_plot = FALSE,
                         reverse_group_order = FALSE,
                         label_size = 6,
                         plt_theme= plt_theme
                         )
```

```{r}
parallel_coordinate_plot(lh,
                         permutation_comparison = "Context_vs_Shock",
                         channels = c("colabel_over_eyfp", "colabel_over_cfos"), 
                         colors =  c("#be0000", "#00782e", "#f09b08", "#f09b08", "#f09b08"),
                         x_label_group_1 = "Context",
                         x_label_group_2 = "Shock",
                         height = 8,
                         width = 10,
                         print_plot = FALSE,
                         reverse_group_order = FALSE,
                         label_size = 6,
                         plt_theme= plt_theme,
                         nudge_x = 2:3
                         )
```



## Create networks

```{r}
# lh <- create_networks(lh,
#                       correlation_list_name = "Context",
#                       channels = c("eyfp"),
#                       alpha = 0.005)
# lh <- create_networks(lh,
#                       correlation_list_name = "Shock",
#                       channels = c("eyfp"),
#                       alpha = 0.005)
# lh <- create_networks(lh,
#                       correlation_list_name = "Context",
#                       channels = c("cfos"),
#                       alpha = 0.002)
# lh <- create_networks(lh,
#                       correlation_list_name = "Shock",
#                       channels = c("cfos"),
#                       alpha = 0.002)


lh <- create_networks(lh,
                      correlation_list_name = "Context",
                      channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),
                      alpha = 0.01)
lh <- create_networks(lh,
                      correlation_list_name = "Shock",
                      channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),
                      alpha = 0.01)
```


## TODO Fix the network plots


```{r}

graph_theme <- ggraph::theme_graph() + theme(plot.title = element_text(hjust = 0.5, size = 36),
                                             legend.text = element_text(size = 18),
                                             legend.title = element_text(size = 18))

plot_networks(lh,
              network_name ="Context",
              channels = c("eyfp"),
              title = "Context",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#00782e",
              label_size = 6,
              label_offset = 0.15)

plot_networks(lh,
              network_name = "Shock",
              channels = c("eyfp"),
              title = "Shock",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#00782e",
              label_size = 6,
              label_offset = 0.15)
```


```{r}
plot_networks(lh,
              network_name ="Context",
              channels = c("cfos"),
              title = "Context",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#be0000",
              label_size = 6,
              label_offset = 0.15)

plot_networks(lh,
              network_name = "Shock",
              channels = c("cfos"),
              title = "Shock",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#be0000",
              label_size = 6,
              label_offset = 0.15)

```



```{r}


plot_networks(lh,
              network_name ="Context",
              channels = c("colabel"),
              title = "Context",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

plot_networks(lh,
              network_name = "Shock",
              channels = c("colabel"),
              title = "Shock",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

```


```{r}


plot_networks(lh,
              network_name ="Context",
              channels = c("colabel_over_eyfp"),
              title = "Context",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

plot_networks(lh,
              network_name = "Shock",
              channels = c("colabel_over_eyfp"),
              title = "Shock",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

```


```{r}


plot_networks(lh,
              network_name ="Context",
              channels = c("colabel_over_cfos"),
              title = "Context",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

plot_networks(lh,
              network_name = "Shock",
              channels = c("colabel_over_cfos"),
              title = "Shock",
              degree_scale_limit = c(1,8),
              height = 10,
              width = 10,
              edge_color = "#f09b08",
              label_size = 6,
              label_offset = 0.15)

```


```{r}
lh <- summarise_networks(lh, 
                         channels = c("eyfp"),
                         network_names = c("Context", "Shock"),
                         save_stats = TRUE,
                         save_degree_distribution = TRUE,
                         save_betweenness_distribution = TRUE,
                         save_efficiency_distribution = TRUE)

lh <- summarise_networks(lh, 
                         channels = c("cfos"),
                         network_names = c("Context", "Shock"),
                         save_stats = TRUE,
                         save_degree_distribution = TRUE,
                         save_betweenness_distribution = TRUE,
                         save_efficiency_distribution = TRUE)

lh <- summarise_networks(lh, 
                         channels = c("colabel", "colabel_over_eyfp", "colabel_over_cfos"),
                         network_names = c("Context", "Shock"),
                         save_stats = TRUE,
                         save_degree_distribution = TRUE,
                         save_betweenness_distribution = TRUE,
                         save_efficiency_distribution = TRUE)
```





Integrate behavioral data to plot correlations
```{r}
library(readxl)
library(dplyr)
library(tidyr)
behavior_file <- "V:\\Simon_Ogundare\\Learned Helplessness\\DV_Split_cleaned_experiment\\behavior\\LH_Behavior_Summary.xlsx"
behavior_df <- read_excel(behavior_file) %>% rename()
behavior_df <- behavior_df %>% dplyr::rename(mouse_ID = Mouse,
                                             group = Group,
                                             beam_breaks = `IR-breaks`,
                                             length = `Session Length`,
                                             avg_latency = `Average latency`) 
behavior_df <- behavior_df %>% dplyr::select(mouse_ID, group, beam_breaks, length, avg_latency)

```


```{r}
# Reach into the combined normalized cell count dataframe
# Parse and search for regions by subregion

channel <- "colabel_over_eyfp"
by <- "group"
values <- "Shock"
acronym <- "PG"

region_acronyms <- c("ACA", "AI", "VISC", "MOs", "ACB", "dDG" ,"PAA", "BMA","BLA", "LA",  "PG", "VTA")
p_list <- vector("list", length(region_acronyms))

# filter by parameters
df_channel <-  lh$combined_normalized_counts[[channel]] 

# Pivot wider
df_channel <- df_channel %>%  dplyr::select(mouse_ID:acronym, normalized.count.by.volume) %>%
  tidyr::pivot_wider(names_from = acronym, values_from = normalized.count.by.volume)

# Rearrange the correlations to be in "anatomical order"
anatomical.order <- c("Isocortex","OLF","HPF","CTXsp","CNU","TH","HY","MB","HB","CB")
common.regions <-  df_channel %>% dplyr::select(-all_of(c('mouse_ID', by))) %>% names()
common.regions.ordered <- anatomical.order %>% purrr::map(SMARTR::get.sub.structure) %>%
  purrr::map(intersect, y=common.regions) %>% unlist()

df_channel <- df_channel %>% dplyr::select(mouse_ID, group, all_of(common.regions.ordered))

# Combine with behavioral data 
df_channel_beh <- df_channel %>% dplyr::inner_join(behavior_df,
                                by= c("mouse_ID",
                                      "group"),
                                unmatched = "drop")
df_channel_beh$group <-  as.factor(df_channel_beh$group)

## Get correlations 
corr_list_shock <- df_channel_beh %>% 
  filter(group == "Shock") %>% 
  dplyr::select(-c("mouse_ID", "group")) %>% 
  as.matrix() %>% 
   Hmisc::rcorr()

corr_list_context <- df_channel_beh %>% 
  filter(group == "Context") %>% 
  dplyr::select(-c("mouse_ID", "group")) %>% 
  as.matrix() %>% 
   Hmisc::rcorr()
    
for (n in 1:length(region_acronyms)){
      
    acronym <- region_acronyms[n]
    
    # Get Pearsons and associated P values
    r_s <- corr_list_shock$r[rownames(corr_list_shock$r) %in% "avg_latency", colnames(corr_list_shock$r) %in% acronym] %>% round(digits = 2)
    p_s <- corr_list_shock$P[rownames(corr_list_shock$P) %in% "avg_latency", colnames(corr_list_shock$P) %in% acronym] %>% round(digits = 2)
    r_c <- corr_list_context$r[rownames(corr_list_context$r) %in% "avg_latency", colnames(corr_list_context$r) %in% acronym] %>% round(digits = 2)
    p_c <- corr_list_context$P[rownames(corr_list_context$P) %in% "avg_latency", colnames(corr_list_context$P) %in% acronym] %>% round(digits = 2)
    
    test <- tibble(group = c("Context", "Shock"),
           x = c(0, 0),
           y = c(1 ,3),
           r = c(r_c, r_s),
           P= c(p_c, p_s))
    
    # Plot 
    p <- ggplot(data=df_channel_beh, aes_string(x = "avg_latency", y = acronym, color = "group")) + 
      geom_point() + geom_smooth(method = "lm", se = FALSE, aes(group = group)) + scale_colour_manual(
      values = c("#000000","#f09b08")) + theme_classic()
    
    p <- p +  annotate("text", x = c(.5,.5), y = c(.32, .3), 
              label = c(paste0("R = ", r_c), paste0("R = ", r_s)) , color=c("#000000","#f09b08"),
              size=3 , angle=0, fontface="bold") +  
      annotate("text", x = c(4.5,4.5), y = c(.32, .3), 
              label = c(paste0("p = ", p_c), paste0("p = ", p_s)) , color=c("#000000","#f09b08"),
              size=3 , angle=0, fontface="bold") 
    p_list[[n]] <- p
} 

```



```{r}

# library(gridExtra)

quartz()
grid.arrange(p_list[[1]], 
             p_list[[2]], 
             p_list[[3]], 
             p_list[[4]], 
             p_list[[5]], 
             p_list[[6]], 
             p_list[[7]], 
             p_list[[8]], 
             p_list[[9]], 
             p_list[[10]], 
             p_list[[11]], 
             p_list[[12]], 
             ncol = 4,
             nrow =3)

```

```{r}

# Reach into the combined normalized cell count dataframe
# Parse and search for regions by subregion

channel <- "colabel_over_cfos"
by <- "group"
values <- "Shock"
acronym <- "PG"

region_acronyms <- c("ACA", "AI", "VISC", "MOs", "ACB", "PAA", "BMA","BLA", "LA", "ZI", "PG", "VTA")
p_list <- vector("list", length(region_acronyms))

# filter by parameters
df_channel <-  e$combined_normalized_counts[[channel]] 

# Pivot wider
df_channel <- df_channel %>%  dplyr::select(mouse_ID:acronym, normalized.count.by.volume) %>%
  tidyr::pivot_wider(names_from = acronym, values_from = normalized.count.by.volume)

# Rearrange the correlations to be in "anatomical order"
anatomical.order <- c("Isocortex","OLF","HPF","CTXsp","CNU","TH","HY","MB","HB","CB")
common.regions <-  df_channel %>% dplyr::select(-all_of(c('mouse_ID', by))) %>% names()
common.regions.ordered <- anatomical.order %>% purrr::map(SMARTR::get.sub.structure) %>%
  purrr::map(intersect, y=common.regions) %>% unlist()

df_channel <- df_channel %>% dplyr::select(mouse_ID, group, all_of(common.regions.ordered))

# Combine with behavioral data 
df_channel_beh <- df_channel %>% dplyr::inner_join(behavior_df,
                                by= c("mouse_ID",
                                      "group"),
                                unmatched = "drop")
df_channel_beh$group <-  as.factor(df_channel_beh$group)

## Get correlations 
corr_list_shock <- df_channel_beh %>% 
  filter(group == "Shock") %>% 
  dplyr::select(-c("mouse_ID", "group")) %>% 
  as.matrix() %>% 
   Hmisc::rcorr()

corr_list_context <- df_channel_beh %>% 
  filter(group == "Context") %>% 
  dplyr::select(-c("mouse_ID", "group")) %>% 
  as.matrix() %>% 
   Hmisc::rcorr()
    
for (n in 1:length(region_acronyms)){
      
    acronym <- region_acronyms[n]
    
    # Get Pearsons and associated P values
    r_s <- corr_list_shock$r[rownames(corr_list_shock$r) %in% "avg_latency", colnames(corr_list_shock$r) %in% acronym] %>% round(digits = 2)
    p_s <- corr_list_shock$P[rownames(corr_list_shock$P) %in% "avg_latency", colnames(corr_list_shock$P) %in% acronym] %>% round(digits = 2)
    r_c <- corr_list_context$r[rownames(corr_list_context$r) %in% "avg_latency", colnames(corr_list_context$r) %in% acronym] %>% round(digits = 2)
    p_c <- corr_list_context$P[rownames(corr_list_context$P) %in% "avg_latency", colnames(corr_list_context$P) %in% acronym] %>% round(digits = 2)
    
    test <- tibble(group = c("Context", "Shock"),
           x = c(0, 0),
           y = c(1 ,3),
           r = c(r_c, r_s),
           P= c(p_c, p_s))
    
    # Plot 
    p <- ggplot(data=df_channel_beh, aes_string(x = "avg_latency", y = acronym, color = "group")) + 
      geom_point() + geom_smooth(method = "lm", se = FALSE, aes(group = group)) + scale_colour_manual(
      values = c("#000000","#f09b08")) + theme_classic()
    
    p <- p +  annotate("text", x = c(.5,.5), y = c(.32, .3), 
              label = c(paste0("R = ", r_c), paste0("R = ", r_s)) , color=c("#000000","#f09b08"),
              size=3 , angle=0, fontface="bold") +  
      annotate("text", x = c(4.5,4.5), y = c(.32, .3), 
              label = c(paste0("p = ", p_c), paste0("p = ", p_s)) , color=c("#000000","#f09b08"),
              size=3 , angle=0, fontface="bold") 
    p_list[[n]] <- p
} 
```

```{r}
# region_acronyms <- c("ACA", "AI", "VISC", "MOs", "ACB", "PAA", "BMA", "LA", "ZI")

library(gridExtra)

quartz()
grid.arrange(p_list[[1]], 
             p_list[[2]], 
             p_list[[3]], 
             p_list[[4]], 
             p_list[[5]], 
             p_list[[6]], 
             p_list[[7]], 
             p_list[[8]], 
             p_list[[9]], 
             p_list[[10]], 
             p_list[[11]], 
             p_list[[12]], 
             ncol = 4,
             nrow =3)

```





```{r}
 write.csv(df_channel_beh, file = "V:\\Simon_Ogundare\\Learned Helplessness\\DV_Experiment_2/colabel_over_cfos_norm_counts_behavior.csv")
```




```{r}

# Reach into the combined normalized cell count dataframe
# Parse and search for regions by subregion

channel <- "eyfp"

region_acronyms <- c("ACA", "AI", "MOs", "ACB", "PAA", "BMA","BLA", "LA", "PG", "PVT",  "VTA", "BST")
p_list <- vector("list", length(region_acronyms))
# filter by parameters
df_channel <-  lh$combined_normalized_counts[[channel]] 

# Pivot wider
df_channel <- df_channel %>%  dplyr::select(mouse_ID:acronym, normalized.count.by.volume) %>%
  tidyr::pivot_wider(names_from = acronym, values_from = normalized.count.by.volume)

# Rearrange the correlations to be in "anatomical order"
anatomical.order <- c("Isocortex","OLF","HPF","CTXsp","CNU","TH","HY","MB","HB","CB")
common.regions <-  df_channel %>% dplyr::select(-all_of(c('mouse_ID', by))) %>% names()
common.regions.ordered <- anatomical.order %>% purrr::map(SMARTR::get.sub.structure) %>%
  purrr::map(intersect, y=common.regions) %>% unlist()

df_channel <- df_channel %>% dplyr::select(mouse_ID, group, all_of(common.regions.ordered))

# Combine with behavioral data 
df_channel_beh <- df_channel %>% dplyr::inner_join(behavior_df,
                                by= c("mouse_ID",
                                      "group"),
                                unmatched = "drop")
df_channel_beh$group <-  as.factor(df_channel_beh$group)

## Get correlations 
corr_list_shock <- df_channel_beh %>% 
  filter(group == "Shock") %>% 
  dplyr::select(-c("mouse_ID", "group")) %>% 
  as.matrix() %>% 
   Hmisc::rcorr()

corr_list_context <- df_channel_beh %>% 
  filter(group == "Context") %>% 
  dplyr::select(-c("mouse_ID", "group")) %>% 
  as.matrix() %>% 
   Hmisc::rcorr()
    
for (n in 1:length(region_acronyms)){
      
    acronym <- region_acronyms[n]
    
    # Get Pearsons and associated P values
    r_s <- corr_list_shock$r[rownames(corr_list_shock$r) %in% "avg_latency", colnames(corr_list_shock$r) %in% acronym] %>% round(digits = 2)
    p_s <- corr_list_shock$P[rownames(corr_list_shock$P) %in% "avg_latency", colnames(corr_list_shock$P) %in% acronym] %>% round(digits = 2)
    r_c <- corr_list_context$r[rownames(corr_list_context$r) %in% "avg_latency", colnames(corr_list_context$r) %in% acronym] %>% round(digits = 2)
    p_c <- corr_list_context$P[rownames(corr_list_context$P) %in% "avg_latency", colnames(corr_list_context$P) %in% acronym] %>% round(digits = 2)
    
    test <- tibble(group = c("Context", "Shock"),
           x = c(0, 0),
           y = c(1 ,3),
           r = c(r_c, r_s),
           P= c(p_c, p_s))
    
    # Plot 
    p <- ggplot(data=df_channel_beh, aes_string(x = "avg_latency", y = acronym, color = "group")) + 
      geom_point() + geom_smooth(method = "lm", se = FALSE, aes(group = group)) + scale_colour_manual(
      values = c("#000000","#f09b08")) + theme_classic()
    
    p <- p +  annotate("text", x = c(.5,.5), y = c(.32, .3), 
              label = c(paste0("R = ", r_c), paste0("R = ", r_s)) , color=c("#000000","#f09b08"),
              size=3 , angle=0, fontface="bold") +  
      annotate("text", x = c(4.5,4.5), y = c(.32, .3), 
              label = c(paste0("p = ", p_c), paste0("p = ", p_s)) , color=c("#000000","#f09b08"),
              size=3 , angle=0, fontface="bold") 
    p_list[[n]] <- p
} 

```


```{r}
# region_acronyms <- c("ACA", "AI", "VISC", "MOs", "ACB", "PAA", "BMA", "LA", "ZI")

library(gridExtra)

quartz()
grid.arrange(p_list[[1]], 
             p_list[[2]], 
             p_list[[3]], 
             p_list[[4]], 
             p_list[[5]], 
             p_list[[6]], 
             p_list[[7]], 
             p_list[[8]], 
             p_list[[9]], 
             p_list[[10]], 
             p_list[[11]], 
             p_list[[12]], 
             ncol = 4,
             nrow =3)

```




```{r}

# Reach into the combined normalized cell count dataframe
# Parse and search for regions by subregion

channel <- "cfos"

region_acronyms <- c("ACA", "AI", "MOs", "ACB", "PAA", "BMA","BLA", "LA", "PG", "PVT",  "VTA", "BST", "TR", "MG", "PVH", "RL")
p_list <- vector("list", length(region_acronyms))

# filter by parameters
df_channel <-  e$combined_normalized_counts[[channel]] 

# Pivot wider
df_channel <- df_channel %>%  dplyr::select(mouse_ID:acronym, normalized.count.by.volume) %>%
  tidyr::pivot_wider(names_from = acronym, values_from = normalized.count.by.volume)

# Rearrange the correlations to be in "anatomical order"
anatomical.order <- c("Isocortex","OLF","HPF","CTXsp","CNU","TH","HY","MB","HB","CB")
common.regions <-  df_channel %>% dplyr::select(-all_of(c('mouse_ID', by))) %>% names()
common.regions.ordered <- anatomical.order %>% purrr::map(SMARTR::get.sub.structure) %>%
  purrr::map(intersect, y=common.regions) %>% unlist()

df_channel <- df_channel %>% dplyr::select(mouse_ID, group, all_of(common.regions.ordered))

# Combine with behavioral data 
df_channel_beh <- df_channel %>% dplyr::inner_join(behavior_df,
                                by= c("mouse_ID",
                                      "group"),
                                unmatched = "drop")
df_channel_beh$group <-  as.factor(df_channel_beh$group)

## Get correlations 
corr_list_shock <- df_channel_beh %>% 
  filter(group == "Shock") %>% 
  dplyr::select(-c("mouse_ID", "group")) %>% 
  as.matrix() %>% 
   Hmisc::rcorr()

corr_list_context <- df_channel_beh %>% 
  filter(group == "Context") %>% 
  dplyr::select(-c("mouse_ID", "group")) %>% 
  as.matrix() %>% 
   Hmisc::rcorr()
    
for (n in 1:length(region_acronyms)){
      
    acronym <- region_acronyms[n]
    
    # Get Pearsons and associated P values
    r_s <- corr_list_shock$r[rownames(corr_list_shock$r) %in% "avg_latency", colnames(corr_list_shock$r) %in% acronym] %>% round(digits = 2)
    p_s <- corr_list_shock$P[rownames(corr_list_shock$P) %in% "avg_latency", colnames(corr_list_shock$P) %in% acronym] %>% round(digits = 2)
    r_c <- corr_list_context$r[rownames(corr_list_context$r) %in% "avg_latency", colnames(corr_list_context$r) %in% acronym] %>% round(digits = 2)
    p_c <- corr_list_context$P[rownames(corr_list_context$P) %in% "avg_latency", colnames(corr_list_context$P) %in% acronym] %>% round(digits = 2)
    
    test <- tibble(group = c("Context", "Shock"),
           x = c(0, 0),
           y = c(1 ,3),
           r = c(r_c, r_s),
           P= c(p_c, p_s))
    
    # Plot 
    p <- ggplot(data=df_channel_beh, aes_string(x = "avg_latency", y = acronym, color = "group")) + 
      geom_point() + geom_smooth(method = "lm", se = FALSE, aes(group = group)) + scale_colour_manual(
      values = c("#000000","#f09b08")) + theme_classic()
    
    p <- p +  annotate("text", x = c(.5,.5), y = c(.32, .3), 
              label = c(paste0("R = ", r_c), paste0("R = ", r_s)) , color=c("#000000","#f09b08"),
              size=3 , angle=0, fontface="bold") +  
      annotate("text", x = c(4.5,4.5), y = c(.32, .3), 
              label = c(paste0("p = ", p_c), paste0("p = ", p_s)) , color=c("#000000","#f09b08"),
              size=3 , angle=0, fontface="bold") 
    p_list[[n]] <- p
} 
```


```{r}
# region_acronyms <- c("ACA", "AI", "VISC", "MOs", "ACB", "PAA", "BMA", "LA", "ZI")

library(gridExtra)

quartz()
grid.arrange(p_list[[1]], 
             p_list[[2]], 
             p_list[[3]], 
             p_list[[4]], 
             p_list[[5]], 
             p_list[[6]], 
             p_list[[7]], 
             p_list[[8]], 
             p_list[[9]], 
             p_list[[10]], 
             p_list[[11]], 
             p_list[[12]], 
             p_list[[13]], 
             p_list[[14]], 
             p_list[[15]], 
             p_list[[16]], 
             ncol = 4,
             nrow =6)

```


# Perform pairwise comparisons in expression across brain regions and add FDR correction for multiple comparisons

```{r}
library(rstatix)
stats.eyfp <- lh$combined_normalized_counts$eyfp %>% group_by(acronym, name) %>% 
  t_test(normalized.count.by.volume~group) %>% adjust_pvalue(method = "BH") %>%
    add_significance()
stats.cfos <- lh$combined_normalized_counts$cfos %>% group_by(acronym, name) %>% 
  t_test(normalized.count.by.volume~group) %>% adjust_pvalue(method = "BH") %>%
    add_significance()
stats.colabel_over_eyfp <- lh$combined_normalized_counts$colabel_over_eyfp %>% group_by(acronym, name) %>% 
  t_test(normalized.count.by.volume~group) %>% adjust_pvalue(method = "BH") %>%
    add_significance()
stats.colabel_over_cfos <- lh$combined_normalized_counts$colabel_over_cfos %>% group_by(acronym, name) %>% 
  t_test(normalized.count.by.volume~group) %>% adjust_pvalue(method = "BH") %>%
    add_significance()
stats.colabel <- lh$combined_normalized_counts$colabel %>% group_by(acronym, name) %>% 
  t_test(normalized.count.by.volume~group) %>% adjust_pvalue(method = "BH") %>%
    add_significance()
```


# Pivot the tables longer to combine with the raw normalized counts

```{r}
# stats.eyfp %>% pivot_longer(cols= starts_with("group"), names_to = NULL, values_to = "group")

 wide_eyfp_norm_counts <- lh$combined_normalized_counts$eyfp %>% group_by(group, acronym, name) %>% 
      summarise(mean.normalized.count.by.volume = mean(normalized.count.by.volume),
      sem.normalized.count.by.volume = SMARTR::sem(normalized.count.by.volume),
      n = n())


 wide_eyfp_norm_counts <-  wide_eyfp_norm_counts %>% pivot_wider(names_from =  group, names_sep = ".", values_from = c(group, acronym, name, mean.normalized.count.by.volume, sem.normalized.count.by.volume, n)) %>% unnest() %>% rename(acronym = acronym.Context,
                          name = name.Context)
 
 
 joined_eyfp_stats <- wide_eyfp_norm_counts %>% select(c(name, acronym, starts_with("mean"), starts_with("sem"))) %>% right_join(stats.eyfp, by = c("acronym", "name")) %>% 
   select(-.y., -group1, -group2) %>% rename(n.Context = n1,
                                             n.Shock = n2)
 
 
 file_name <- attr(lh, "info")$output_path %>% file.path("eyfp_regions_stats_table.csv")
 write.csv(joined_eyfp_stats, file_name)
```


```{r}
# stats.cfos %>% pivot_longer(cols= starts_with("group"), names_to = NULL, values_to = "group")

 wide_cfos_norm_counts <- lh$combined_normalized_counts$cfos %>% group_by(group, acronym, name) %>% 
      summarise(mean.normalized.count.by.volume = mean(normalized.count.by.volume),
      sem.normalized.count.by.volume = SMARTR::sem(normalized.count.by.volume),
      n = n())


 wide_cfos_norm_counts <-  wide_cfos_norm_counts %>% pivot_wider(names_from =  group, names_sep = ".", values_from = c(group, acronym, name, mean.normalized.count.by.volume, sem.normalized.count.by.volume, n)) %>%  
      unnest() %>% rename(acronym = acronym.Context,
                          name = name.Context)
 
 
 joined_cfos_stats <- wide_cfos_norm_counts %>% select(c(name, acronym, starts_with("mean"), starts_with("sem"))) %>% right_join(stats.cfos, by = c("acronym", "name")) %>% 
   select(-.y., -group1, -group2) %>% rename(n.Context = n1,
                                             n.Shock = n2)
 
 
 file_name <- attr(lh, "info")$output_path %>% file.path("cfos_regions_stats_table.csv")
 write.csv(joined_cfos_stats, file_name)
```

```{r}
# stats.colabel_over_eyfp %>% pivot_longer(cols= starts_with("group"), names_to = NULL, values_to = "group")

 wide_colabel_over_eyfp_norm_counts <- lh$combined_normalized_counts$colabel_over_eyfp %>% group_by(group, acronym, name) %>% 
      summarise(mean.normalized.count.by.volume = mean(normalized.count.by.volume),
      sem.normalized.count.by.volume = SMARTR::sem(normalized.count.by.volume),
      n = n())


 wide_colabel_over_eyfp_norm_counts <-  wide_colabel_over_eyfp_norm_counts %>% pivot_wider(names_from =  group, names_sep = ".", values_from = c(group, acronym, name, mean.normalized.count.by.volume, sem.normalized.count.by.volume, n)) %>%  
      unnest() %>% rename(acronym = acronym.Context,
                          name = name.Context)
 
 
 joined_colabel_over_eyfp_stats <- wide_colabel_over_eyfp_norm_counts %>% select(c(name, acronym, starts_with("mean"), starts_with("sem"))) %>% right_join(stats.colabel_over_eyfp, by = c("acronym", "name")) %>% 
   select(-.y., -group1, -group2) %>% rename(n.Context = n1,
                                             n.Shock = n2)
 
 
 file_name <- attr(lh, "info")$output_path %>% file.path("colabel_over_eyfp_regions_stats_table.csv")
 write.csv(joined_colabel_over_eyfp_stats, file_name)
```

```{r}
# stats.colabel_over_cfos %>% pivot_longer(cols= starts_with("group"), names_to = NULL, values_to = "group")

 wide_colabel_over_cfos_norm_counts <- lh$combined_normalized_counts$colabel_over_cfos %>% group_by(group, acronym, name) %>% 
      summarise(mean.normalized.count.by.volume = mean(normalized.count.by.volume),
      sem.normalized.count.by.volume = SMARTR::sem(normalized.count.by.volume),
      n = n())


 wide_colabel_over_cfos_norm_counts <-  wide_colabel_over_cfos_norm_counts %>% pivot_wider(names_from =  group, names_sep = ".", values_from = c(group, acronym, name, mean.normalized.count.by.volume, sem.normalized.count.by.volume, n)) %>%  
      unnest() %>% rename(acronym = acronym.Context,
                          name = name.Context)
 
 
 joined_colabel_over_cfos_stats <- wide_colabel_over_cfos_norm_counts %>% select(c(name, acronym, starts_with("mean"), starts_with("sem"))) %>% right_join(stats.colabel_over_cfos, by = c("acronym", "name")) %>% 
   select(-.y., -group1, -group2) %>% rename(n.Context = n1,
                                             n.Shock = n2)
 
 file_name <- attr(lh, "info")$output_path %>% file.path("colabel_over_cfos_regions_stats_table.csv")
 write.csv(joined_colabel_over_cfos_stats, file_name)
```

```{r}
# stats.colabel %>% pivot_longer(cols= starts_with("group"), names_to = NULL, values_to = "group")

wide_colabel_norm_counts <- lh$combined_normalized_counts$colabel %>% group_by(group, acronym, name) %>% 
      summarise(mean.normalized.count.by.volume = mean(normalized.count.by.volume),
      sem.normalized.count.by.volume = SMARTR::sem(normalized.count.by.volume),
      n = n())


 wide_colabel_norm_counts <-  wide_colabel_norm_counts %>% pivot_wider(names_from =  group, names_sep = ".", values_from = c(group, acronym, name, mean.normalized.count.by.volume, sem.normalized.count.by.volume, n)) %>%  
      unnest() %>% rename(acronym = acronym.Context,
                          name = name.Context)
 
 
 joined_colabel_stats <- wide_colabel_norm_counts %>% select(c(name, acronym, starts_with("mean"), starts_with("sem"))) %>% right_join(stats.colabel, by = c("acronym", "name")) %>% 
   select(-.y., -group1, -group2) %>% rename(n.Context = n1,
                                             n.Shock = n2)
 
 file_name <- attr(lh, "info")$output_path %>% file.path("colabel_regions_stats_table.csv")
 write.csv(joined_colabel_stats, file_name)
